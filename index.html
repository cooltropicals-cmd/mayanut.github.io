<script>
/* ========= Mini SFX engine (Web Audio) ========= */
(function(){
  const SFX = {
    ctx: null, master: null, enabled: true, ready:false,
    ensure(){
      if (this.ctx) return;
      try{
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.master = this.ctx.createGain();
        this.master.gain.value = 0.35; // overall loudness
        this.master.connect(this.ctx.destination);
        this.ready = true;
      }catch(e){ console.warn("AudioContext failed:", e); }
    },
    async resume(){ try{ this.ensure(); if (this.ctx && this.ctx.state==='suspended') await this.ctx.resume(); }catch{} },
    toggleMute(){
      this.enabled = !this.enabled;
      if (this.master) this.master.gain.value = this.enabled ? 0.35 : 0.0;
      const ico = document.getElementById('audioToggle');
      if (ico) ico.textContent = this.enabled ? 'ðŸ”Š' : 'ðŸ”ˆ';
    },
    // helpers
    nodeTTL(node, t){ try{ node.stop(t); }catch{} },
    env(t0, dur, a=0.001, d=0.08, s=0.2, r=0.14){
      const ctx=this.ctx, g=ctx.createGain(); g.gain.setValueAtTime(0, t0);
      g.gain.linearRampToValueAtTime(a, t0 + a);
      g.gain.exponentialRampToValueAtTime(s, t0 + a + d);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur + r);
      return g;
    },
    // SFX types
    tap(intensity=0.6){
      if (!this.ready || !this.enabled) return;
      const c=this.ctx, t=c.currentTime;
      const o=c.createOscillator(); o.type='sine';
      o.frequency.setValueAtTime(220+intensity*180, t);
      o.frequency.exponentialRampToValueAtTime(120, t+0.08);
      const g=this.env(t, 0.05, 0.002, 0.04, 0.08, 0.05);
      o.connect(g).connect(this.master);
      o.start(t); this.nodeTTL(o, t+0.12);
    },
    squish(intensity=0.8){
      if (!this.ready || !this.enabled) return;
      const c=this.ctx, t=c.currentTime;
      // filtered noise with quick pitchy throb
      const buf=c.createBuffer(1, 2048, c.sampleRate);
      const data=buf.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.6;
      const src=c.createBufferSource(); src.buffer=buf; src.loop=false;
      const bp=c.createBiquadFilter(); bp.type='bandpass';
      bp.frequency.setValueAtTime(400+intensity*600, t);
      bp.Q.setValueAtTime(4, t);
      const g=this.env(t, 0.12, 0.004, 0.08, 0.15, 0.08);
      src.connect(bp).connect(g).connect(this.master);
      src.start(t); this.nodeTTL(src, t+0.25);
    },
    gloop(){
      if (!this.ready || !this.enabled) return;
      const c=this.ctx, t=c.currentTime;
      const o=c.createOscillator(); o.type='triangle';
      o.frequency.setValueAtTime(140, t);
      o.frequency.exponentialRampToValueAtTime(70, t+0.18);
      const g=this.env(t, 0.18, 0.006, 0.12, 0.25, 0.12);
      o.connect(g).connect(this.master);
      o.start(t); this.nodeTTL(o, t+0.32);
    },
    pop(){
      if (!this.ready || !this.enabled) return;
      const c=this.ctx, t=c.currentTime;
      const o=c.createOscillator(); o.type='sine';
      o.frequency.setValueAtTime(520, t);
      o.frequency.exponentialRampToValueAtTime(1200, t+0.03);
      const g=this.env(t, 0.08, 0.002, 0.04, 0.12, 0.06);
      o.connect(g).connect(this.master);
      o.start(t); this.nodeTTL(o, t+0.14);
    },
    novaCharge(){
      if (!this.ready || !this.enabled) return;
      const c=this.ctx, t=c.currentTime;
      const o=c.createOscillator(); o.type='sawtooth';
      const g=this.env(t, 0.7, 0.02, 0.4, 0.12, 0.3);
      o.frequency.setValueAtTime(160, t);
      o.frequency.linearRampToValueAtTime(260, t+0.6);
      o.connect(g).connect(this.master);
      o.start(t); this.nodeTTL(o, t+0.8);
    },
    novaBoom(){
      if (!this.ready || !this.enabled) return;
      const c=this.ctx, t=c.currentTime;
      const o=c.createOscillator(); o.type='square';
      o.frequency.setValueAtTime(90, t);
      o.frequency.exponentialRampToValueAtTime(40, t+0.25);
      const g=this.env(t, 0.25, 0.01, 0.18, 0.25, 0.22);
      o.connect(g).connect(this.master);
      o.start(t); this.nodeTTL(o, t+0.5);
    },
    tick(){
      if (!this.ready || !this.enabled) return;
      const c=this.ctx, t=c.currentTime;
      const o=c.createOscillator(); o.type='triangle';
      o.frequency.setValueAtTime(1200, t);
      const g=this.env(t, 0.05, 0.001, 0.02, 0.05, 0.03);
      o.connect(g).connect(this.master);
      o.start(t); this.nodeTTL(o, t+0.08);
    },
    bass(){
      if (!this.ready || !this.enabled) return;
      const c=this.ctx, t=c.currentTime;
      const o=c.createOscillator(); o.type='sine';
      o.frequency.setValueAtTime(70, t);
      o.frequency.exponentialRampToValueAtTime(48, t+0.22);
      const g=this.env(t, 0.22, 0.01, 0.16, 0.25, 0.2);
      o.connect(g).connect(this.master);
      o.start(t); this.nodeTTL(o, t+0.45);
    }
  };
  // expose minimal hooks
  window.__SFX = SFX;
  // resume on first user gesture
  const autounlock = () => { SFX.ensure(); SFX.resume(); window.removeEventListener('pointerdown', autounlock); window.removeEventListener('keydown', autounlock); };
  window.addEventListener('pointerdown', autounlock, {once:true});
  window.addEventListener('keydown', autounlock, {once:true});

  // Add a mute/unmute button next to score
  window.addEventListener('DOMContentLoaded', ()=>{
    const hud = document.getElementById('scoreHUD');
    if (!hud) return;
    const btn = document.createElement('button');
    btn.id='audioToggle';
    btn.textContent='ðŸ”Š';
    btn.style.cssText='margin-left:8px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:#eaf2ff; border-radius:8px; padding:2px 6px; cursor:pointer;';
    btn.onclick=()=>SFX.toggleMute();
    hud.appendChild(btn);
  });
})();

/* ========= Chat + Site (same as before, plus pause/commands) ========= */
const input = document.getElementById('chatInput');
const logBox = document.getElementById('chatLog');
const pausedBadge = document.getElementById('pausedBadge');
let GAME_PAUSED = false;
let lastMouse = {x: window.innerWidth/2, y: window.innerHeight/2};
document.addEventListener('mousemove', (e)=>{ lastMouse.x=e.clientX; lastMouse.y=e.clientY; });

function say(role, text){
  const el = document.createElement('div');
  el.className = 'msg';
  el.innerHTML = `<strong>${role}:</strong> ${text}`;
  logBox.appendChild(el);
  logBox.scrollTop = logBox.scrollHeight;
}
function setPaused(v){
  GAME_PAUSED = !!v;
  pausedBadge.style.display = GAME_PAUSED ? '' : 'none';
}
function togglePause(){ setPaused(!GAME_PAUSED); }

function handleMessage(v){
  const t = (v||'').trim(); if(!t) return; say('You', t);
  const low = t.toLowerCase();

  if (['pause'].includes(low)){ setPaused(true); say('MayaNut','Paused. Type "resume" or press Space to play.'); return; }
  if (['unpause','resume','continue'].includes(low)){ setPaused(false); say('MayaNut','Resumed.'); return; }

  if (low === 'brosimum'){
    window.spawnWhitesAt(lastMouse.x, lastMouse.y, 100);
    say('MayaNut','Brosimum powertool: unleashed white balls (up to cap).');
    return;
  }

  const domainTriggers = [
    "domain for sale","is this domain for sale","sell this domain","sell the domain",
    "buy this domain","buy the domain","is the domain for sale","are you selling the domain",
    "is mayanut.com for sale","for sale domain","purchase this domain","can i buy this domain"
  ];
  if (domainTriggers.some(k=>low.includes(k))) { say('MayaNut','mayanut.com is Not for Sale'); return; }

  if (low.includes('buy') || low.includes('product') || low.includes('shop')) {
    say('MayaNut','Head to the Buy section below for our upcoming products. (Placeholders for now.)');
    document.getElementById('buy').scrollIntoView({behavior:'smooth'}); return;
  }
  if (low.includes('about') || low.includes('company')) {
    say('MayaNut','Weâ€™re a South Florida company promoting the Maya Nut tree. Scroll to the About section for details.');
    document.getElementById('about').scrollIntoView({behavior:'smooth'}); return;
  }
  say('MayaNut', "Tell me what you want and Iâ€™ll point you in the right direction.");
}
input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ handleMessage(input.value); input.value = ''; }});
document.addEventListener('keydown', (e)=>{
  if (e.code === 'Space'){
    const ae = document.activeElement;
    if (ae && (ae === input || ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA')) return;
    e.preventDefault(); togglePause(); __SFX.resume();
  }
});
document.getElementById('navHome').addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('home').scrollIntoView({behavior:'smooth'}); input.focus(); });
document.getElementById('navBuy').addEventListener('click',  (e)=>{ e.preventDefault(); document.getElementById('buy').scrollIntoView({behavior:'smooth'}); });
document.getElementById('navAbout').addEventListener('click',(e)=>{ e.preventDefault(); document.getElementById('about').scrollIntoView({behavior:'smooth'}); });

/* ===== Firebase placeholders (unchanged) ===== */
const FIREBASE_CONFIG = { apiKey:"YOUR_API_KEY", authDomain:"YOUR_PROJECT_ID.firebaseapp.com", projectId:"YOUR_PROJECT_ID", appId:"YOUR_APP_ID" };
const SCORE_FN_URL = "https://YOUR_REGION-YOUR_PROJECT.cloudfunctions.net/submitScore";
window.mnAuth = {
  ready:false, user:null,
  async init(){
    try{
      const [{ initializeApp }] = await Promise.all([ import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js") ]);
      const app = initializeApp(FIREBASE_CONFIG);
      const [{ getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut },
             { getFirestore, doc, getDoc, setDoc } ] = await Promise.all([
        import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"),
        import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js")
      ]);
      this._auth=getAuth(app); this._db=getFirestore(app);
      this._doc=doc; this._getDoc=getDoc; this._setDoc=setDoc;
      this._create=createUserWithEmailAndPassword; this._signin=signInWithEmailAndPassword; this._signout=signOut;
      onAuthStateChanged(this._auth, u=>{ this.user=u||null; authInfo.textContent = u?`Signed in as ${u.email}`:'Guest mode. Sign in to save scores.'; });
      this.ready=true;
    }catch(e){ console.warn("Firebase offline/disabled.", e); }
  },
  async signUp(email, pass){ if(!this.ready) return; await this._create(this._auth, email, pass); },
  async signIn(email, pass){ if(!this.ready) return; await this._signin(this._auth, email, pass); },
  async signOut(){ if(!this.ready) return; await this._signout(this._auth); },
  async submitScore(score, extras={}){ try{
    if(!this.user) return {ok:false, needLogin:true};
    const token = await this._auth.currentUser.getIdToken(false);
    const r = await fetch(SCORE_FN_URL,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify({score,sessionStats:extras})});
    const data = await r.json(); if(!r.ok) throw new Error(data?.error||"submit failed"); return {ok:true,data};
  }catch(e){ console.warn("Cloud save failed.", e); return {ok:false, offline:true};}}
};
mnAuth.init();

/* ===== Game engine with SFX (collisions now play sounds) ===== */
(function(){
  const scoreEl = document.getElementById('score');
  const ballCountEl = document.getElementById('ballCount');
  const ballCapEl   = document.getElementById('ballCap');
  const MAX_BALLS = 120;
  if (ballCapEl) ballCapEl.textContent = MAX_BALLS;

  // Types:
  // 'original' | 'small' | 'spawner' | 'blob'
  // 'redSmall' | 'redBig' | 'redBigDot' | 'blackBig'
  // 'cyanSwift' | 'amberHeavy' | 'violetGhost' | 'greenSeeker' | 'crimsonNova' | 'shard'
  const canvas = document.getElementById('ballLayer');
  const ctx = canvas.getContext('2d');

  function resize(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.style.width = window.innerWidth+'px';
    canvas.style.height = window.innerHeight+'px';
    canvas.width = Math.round(window.innerWidth*dpr);
    canvas.height= Math.round(window.innerHeight*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  resize(); window.addEventListener('resize', resize);

  const heroTitle = document.getElementById('heroTitle');
  const chatInput = document.getElementById('chatInput');
  const chatLog  = document.getElementById('chatLog');
  const buySec   = document.getElementById('buy');
  const aboutSec = document.getElementById('about');
  const topbar   = document.querySelector('.topbar');

  function getRects(){
    const list = [heroTitle, chatInput, chatLog, buySec, aboutSec, topbar];
    const rects = [];
    for (const el of list){
      if(!el) continue;
      const r = el.getBoundingClientRect();
      if (r.bottom >= -50 && r.top <= window.innerHeight + 50) {
        rects.push({x:r.left, y:r.top, w:r.width, h:r.height});
      }
    }
    return rects;
  }

  let score = 0;
  const addScore = d => { score += d; scoreEl.textContent = score; };

  function tierToRadius(tier){ const t = Math.max(1, Math.min(15, tier|0)); return 8 + (4 * (t - 1) / 14); }
  function makeBall(o={}){
    const {x=window.innerWidth*0.6, y=window.innerHeight*0.3, r=10, vx=3, vy=2, type='small', sizeTier=null, hasFast=false} = o;
    return { x,y,r,vx,vy,type,sizeTier,hasFast, squashTimer:0, squashAxis:'y', jellyTimer:0, jellyPhase:0, balloonTimer:0, balloonAxis:'y', life:0, trail:[], _dead:false };
  }
  const balls = [ makeBall({ type:'original', vx:1.1, vy:0.9, r:tierToRadius(7), sizeTier:7 }) ];

  function updateBallCount(){ if(ballCountEl) ballCountEl.textContent = String(balls.filter(b=>!b._dead).length); }

  const CELL=48;
  function buildGrid(){
    const grid = new Map();
    for(let i=0;i<balls.length;i++){
      const b=balls[i]; if(b._dead) continue;
      const minx=Math.floor((b.x-b.r)/CELL), maxx=Math.floor((b.x+b.r)/CELL);
      const miny=Math.floor((b.y-b.r)/CELL), maxy=Math.floor((b.y+b.r)/CELL);
      for(let gx=minx; gx<=maxx; gx++){
        for(let gy=miny; gy<=maxy; gy++){
          const key=gx+','+gy; if(!grid.has(key)) grid.set(key,[]);
          grid.get(key).push(i);
        }
      }
    }
    return grid;
  }
  function nearbyPairs(grid){
    const seen=new Set(), pairs=[];
    for(const ids of grid.values()){
      for(let a=0;a<ids.length;a++){
        for(let b=a+1;b<ids.length;b++){
          const i=ids[a], j=ids[b], key = i<j?`${i}-${j}`:`${j}-${i}`;
          if(seen.has(key)) continue; seen.add(key); pairs.push([i,j]);
        }
      }
    }
    return pairs;
  }

  function bounceWall(b,W,H){
    let hit=false, intensity=0.6;
    if (b.x - b.r < 0){ b.x = b.r; b.vx = Math.abs(b.vx); b.squashTimer=8; b.squashAxis='x'; hit=true; intensity=Math.abs(b.vx)+Math.abs(b.vy); }
    if (b.x + b.r > W){ b.x = W - b.r; b.vx = -Math.abs(b.vx); b.squashTimer=8; b.squashAxis='x'; hit=true; intensity=Math.abs(b.vx)+Math.abs(b.vy); }
    if (b.y - b.r < 0){ b.y = b.r; b.vy = Math.abs(b.vy); b.squashTimer=8; b.squashAxis='y'; hit=true; intensity=Math.abs(b.vx)+Math.abs(b.vy); }
    if (b.y + b.r > H){ b.y = H - b.r; b.vy = -Math.abs(b.vy); b.squashTimer=8; b.squashAxis='y'; hit=true; intensity=Math.abs(b.vx)+Math.abs(b.vy); }
    if (hit) __SFX.tap(Math.min(1, intensity/8));
  }
  function collideWithRect(b,R){
    const ghosty = (b.type==='violetGhost');
    const nx = Math.max(R.x, Math.min(b.x, R.x + R.w));
    const ny = Math.max(R.y, Math.min(b.y, R.y + R.h));
    const dx=b.x-nx, dy=b.y-ny;
    if (dx*dx+dy*dy>b.r*b.r) return false;
    if (ghosty) return false;

    const cx = R.x+R.w/2, cy=R.y+R.h/2;
    const ox = (R.w/2 + b.r) - Math.abs(b.x - cx);
    const oy = (R.h/2 + b.r) - Math.abs(b.y - cy);
    if (ox < oy){ b.vx *= -1; b.x += (b.vx>0?1:-1)*Math.max(1,ox*0.6); b.squashTimer=8; b.squashAxis='x'; }
    else { b.vy *= -1; b.y += (b.vy>0?1:-1)*Math.max(1,oy*0.6); b.squashTimer=8; b.squashAxis='y'; }
    if (b.type==='blob' && b.r>=12 && b.balloonTimer===0){ b.balloonTimer=18; b.balloonAxis=(ox<oy)?'x':'y'; }
    __SFX.squish(0.6);
    return true;
  }

  function redsCount(){ return balls.reduce((n,b)=>n+(!b._dead && (b.type==='redSmall'||b.type==='redBig'||b.type==='redBigDot')?1:0),0); }
  function whitesCount(){ const whiteTypes = new Set(['original','small','spawner','blob','cyanSwift','amberHeavy','violetGhost','greenSeeker']); return balls.reduce((n,b)=>n+(!b._dead && whiteTypes.has(b.type)?1:0),0); }

  function accelerateOriginal(b){
    const speed = Math.hypot(b.vx,b.vy);
    const cap = (b.hasFast?9:4);
    const accel = 0.002;
    const ns = Math.min(cap, speed*(1+accel));
    if (ns>0 && speed>0){ const f=ns/speed; b.vx*=f; b.vy*=f; }
  }
  function randomDottedChance(){ const N = Math.floor(Math.random()*(44-19+1)) + 19; return Math.random() < (1/N); }

  function handleBallVsBall(i,j){
    const a=balls[i], b=balls[j];
    if (a._dead || b._dead) return;
    const dx=b.x-a.x, dy=b.y-a.y;
    const dist = Math.hypot(dx,dy);
    if (dist > a.r + b.r) return;

    // quick magnitude for sound intensity
    const rel = Math.min(1, Math.hypot(a.vx-b.vx, a.vy-b.vy)/12);

    // Shards carve reds
    if (a.type==='shard' || b.type==='shard'){
      const shard = a.type==='shard'?a:b;
      const other = a.type==='shard'?b:a;
      if (other.type==='redSmall'){ other._dead=true; __SFX.tick(); }
      else if (other.type==='redBig' || other.type==='redBigDot'){ other.type='redSmall'; other.r=Math.max(7.5, other.r*0.7); __SFX.tick(); }
      shard.life+=15; if (shard.life>120) shard._dead=true;
      return;
    }

    // Black interactions
    if (a.type==='blackBig' || b.type==='blackBig'){
      let black = a.type==='blackBig'?a:b;
      let other = a.type==='blackBig'?b:a;
      if (other.type==='redSmall'){ other._dead=true; __SFX.bass(); return; }
      if (other.type==='blackBig'){ a._dead=true; b._dead=true; spawnWhites((a.x+b.x)/2,(a.y+b.y)/2,3); __SFX.bass(); return; }
      other.vx *= -0.9; other.vy *= -0.9; __SFX.tap(0.7); return;
    }

    // Dotted reds â†’ Nova
    if (a.type==='redBigDot' && b.type==='redBigDot'){
      a._dead=true; b._dead=true;
      const nova = makeBall({ x:(a.x+b.x)/2, y:(a.y+b.y)/2, r:14, vx:0, vy:0, type:'crimsonNova' });
      nova.life = 0; balls.push(nova);
      __SFX.novaCharge();
      return;
    }

    // Red vs Red
    if (a.type.startsWith('red') && b.type.startsWith('red')){
      if (a.type==='redSmall' && b.type==='redSmall'){
        (Math.random()<0.5?a:b)._dead = true;
      } else if ((a.type==='redBig' || a.type==='redBigDot') && (b.type==='redBig' || b.type==='redBigDot')){
        a.vx*=0.9; a.vy*=0.9; b.vx*=0.9; b.vy*=0.9;
      } else {
        (a.type==='redSmall'?a:b)._dead = true;
      }
      if (whitesCount()===0 && balls.filter(bb=>!bb._dead).length < MAX_BALLS && Math.random()<0.35){
        const cx=(a.x+b.x)/2, cy=(a.y+b.y)/2, ang=Math.random()*Math.PI*2, sp=1.5+Math.random();
        balls.push(makeBall({ x:cx, y:cy, r:6.5, vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp, type:'small' }));
      }
      __SFX.squish(0.5+0.5*rel);
      return;
    }

    // Red vs White
    if (a.type.startsWith('red') || b.type.startsWith('red')){
      let red = a.type.startsWith('red')?a:b;
      let w   = a.type.startsWith('red')?b:a;
      if (w.type==='greenSeeker'){ const ux = dx/(dist||1), uy=dy/(dist||1); red.vx += ux*1.2; red.vy += uy*1.2; __SFX.tap(0.5); return; }
      if (red.type==='redSmall'){
        if (w.type==='spawner' || w.type==='original'){ red._dead = true; __SFX.tap(0.6); return; }
        if (w.type==='small' || w.type==='blob' || w.type==='violetGhost' || w.type==='cyanSwift'){
          w._dead = true;
          red.type = randomDottedChance() ? 'redBigDot' : 'redBig';
          red.r = Math.max(red.r, 10.5);
          red.vx*=0.95; red.vy*=0.95;
          __SFX.pop();
          return;
        }
      } else {
        if (w.type!=='blackBig'){ w._dead = true; }
        red.vx*=0.98; red.vy*=0.98; __SFX.squish(0.7); return;
      }
    }

    // Spawner + Spawner -> blob
    if ((a.type==='spawner' || a.type==='original') && (b.type==='spawner' || b.type==='original')){
      const nx=(a.x+b.x)/2, ny=(a.y+b.y)/2, nvx=(a.vx+b.vx)/2, nvy=(a.vy+b.vy)/2;
      const nr = Math.max(10, Math.sqrt(a.r*a.r + b.r*b.r));
      a._dead=true; b._dead=true;
      if (aliveCount() < MAX_BALLS){
        const blob = makeBall({ x:nx, y:ny, vx:nvx, vy:nvy, r:nr, type:'blob' });
        blob.jellyTimer=28; blob.jellyPhase=0; balls.push(blob);
        __SFX.gloop();
      }
      return;
    }

    // Blob + Small -> Amber Heavy
    if ((a.type==='blob' && b.type==='small') || (b.type==='blob' && a.type==='small')){
      const c = a.type==='blob'?a:b, s = a.type==='small'?a:b;
      c._dead = true; s._dead = true;
      if (aliveCount() < MAX_BALLS){
        const heavy = makeBall({ x:c.x, y:c.y, r:Math.max(11,c.r), vx:(c.vx+s.vx)/2*0.6, vy:(c.vy+s.vy)/2*0.6, type:'amberHeavy' });
        balls.push(heavy);
        __SFX.gloop();
      }
      return;
    }

    // Small + Small (10% Cyan Swift)
    if (a.type==='small' && b.type==='small'){
      const chance = Math.random() < 0.10;
      const nx=(a.x+b.x)/2, ny=(a.y+b.y)/2, nvx=(a.vx+b.vx)/2, nvy=(a.vy+b.vy)/2;
      const nr=Math.sqrt(a.r*a.r + b.r*b.r);
      a._dead=true; b._dead=true;
      if (aliveCount() < MAX_BALLS){
        if (chance){
          const swift = makeBall({ x:nx, y:ny, vx:nvx*1.4, vy:nvy*1.4, r:Math.max(7.5,nr*0.9), type:'cyanSwift' });
          balls.push(swift); __SFX.tap(0.8);
        } else {
          const sp = makeBall({ x:nx, y:ny, vx:nvx, vy:nvy, r:Math.max(9,nr), type:'spawner' });
          sp.jellyTimer=16; sp.jellyPhase=0; balls.push(sp); __SFX.squish(0.5);
        }
      }
      return;
    }

    // Cyan Swift + Small â†’ Green Seeker
    if ((a.type==='cyanSwift' && b.type==='small') || (b.type==='cyanSwift' && a.type==='small')){
      const c = a.type==='cyanSwift'?a:b, s = a.type==='small'?a:b;
      c._dead = true; s._dead = true;
      if (aliveCount() < MAX_BALLS){
        const g = makeBall({ x:(c.x+s.x)/2, y:(c.y+s.y)/2, r:10, vx:(c.vx+s.vx)/2, vy:(c.vy+s.vy)/2, type:'greenSeeker' });
        balls.push(g); __SFX.tap(0.7);
      }
      return;
    }

    // Original + Small â†’ 5% Violet Ghost
    if ((a.type==='original' && b.type==='small') || (b.type==='small' && a.type==='original')){
      if (Math.random() < 0.05){
        const o = a.type==='original'?a:b, s = a.type==='small'?a:b;
        s._dead = true;
        if (aliveCount() < MAX_BALLS){
          balls.push(makeBall({ x:(o.x+s.x)/2, y:(o.y+s.y)/2, r:9, vx:(o.vx+s.vx)/2, vy:(o.vy+s.vy)/2, type:'violetGhost' }));
          __SFX.tap(0.6);
        }
        return;
      }
    }

    // default elastic bounce
    const nx = dx/(dist||1), ny=dy/(dist||1);
    const p = 2*(a.vx*nx+a.vy*ny - b.vx*nx - b.vy*ny)/2;
    a.vx -= p*nx; a.vy -= p*ny; b.vx += p*nx; b.vy += p*ny;
    a.squashTimer=b.squashTimer=8; a.squashAxis=Math.abs(nx)>Math.abs(ny)?'x':'y'; b.squashAxis=a.squashAxis;
    __SFX.squish(0.4+0.6*rel);
  }

  function aliveCount(){ return balls.filter(b=>!b._dead).length; }

  function antiOrbit(b){
    if (b.type!=='small') return;
    const near = balls.find(x=>!x._dead && (x.type==='spawner'||x.type==='original') && Math.hypot(x.x-b.x,x.y-b.y) < (x.r + b.r + 18));
    if (near){
      const ang = Math.random()*Math.PI*2, kick = 0.6 + Math.random()*0.8;
      b.vx += Math.cos(ang)*kick; b.vy += Math.sin(ang)*kick;
    }
  }

  function drawTrail(trail, color){
    ctx.save(); ctx.globalAlpha = 0.35;
    for (let i=0;i<trail.length;i++){
      const t = trail[i];
      const a = (i+1)/trail.length;
      ctx.beginPath(); ctx.arc(t.x, t.y, t.r*a*0.9, 0, Math.PI*2);
      ctx.fillStyle = color; ctx.fill();
    }
    ctx.restore();
  }

  function drawBall(b){
    let sx=1, sy=1;
    if (b.squashTimer>0){ const t=b.squashTimer/8, amt=0.35*Math.sin(t*Math.PI); if(b.squashAxis==='x'){sx=1+amt;sy=1-amt;} else {sy=1+amt;sx=1-amt;} }
    if (b.jellyTimer>0){ const wob=0.15*Math.sin((b.jellyPhase+=0.35)); sx*=1+wob; sy*=1-wob; }
    if (b.balloonTimer>0){ const t=b.balloonTimer/20, bow=0.45*Math.sin((1-t)*Math.PI); if(b.balloonAxis==='x'){sx*=1+bow;sy*=1-bow*0.6;} else {sy*=1+bow;sx*=1-bow*0.6;} }

    if (b.type==='cyanSwift' || b.type==='greenSeeker'){
      b.trail.push({x:b.x, y:b.y, r:Math.max(4,b.r*0.6)});
      if (b.trail.length>10) b.trail.shift();
      drawTrail(b.trail, b.type==='cyanSwift' ? 'rgba(123,233,240,.6)' : 'rgba(122,255,180,.55)');
    } else { b.trail.length = 0; }

    ctx.save(); ctx.translate(b.x,b.y); ctx.scale(sx,sy);

    if (b.type==='shard'){
      ctx.rotate((b.life%360) * Math.PI/180);
      ctx.beginPath();
      const R = b.r;
      ctx.moveTo(R,0);
      ctx.lineTo(-R*0.6, R*0.6);
      ctx.lineTo(-R*0.6,-R*0.6);
      ctx.closePath();
      ctx.fillStyle='rgba(250,240,255,.95)';
      ctx.fill();
      ctx.restore(); return;
    }

    ctx.beginPath(); ctx.arc(0,0,b.r+3,0,Math.PI*2);
    let glow='rgba(255,255,255,.40)';
    if (b.type==='redSmall' || b.type==='redBig' || b.type==='redBigDot') glow='rgba(255,77,77,.35)';
    if (b.type==='blob') glow='rgba(255,138,214,.35)';
    if (b.type==='blackBig') glow='rgba(60,60,60,.45)';
    if (b.type==='cyanSwift') glow='rgba(123,233,240,.35)';
    if (b.type==='amberHeavy') glow='rgba(255,210,120,.35)';
    if (b.type==='violetGhost') glow='rgba(190,140,255,.28)';
    if (b.type==='greenSeeker') glow='rgba(120,255,190,.35)';
    if (b.type==='crimsonNova') glow='rgba(255,90,120,.45)';
    ctx.fillStyle=glow; ctx.fill();

    if (b.type==='crimsonNova'){
      ctx.beginPath(); ctx.arc(0,0,b.r,0,Math.PI*2);
      ctx.fillStyle='#ff5a78'; ctx.fill();
      ctx.lineWidth=2; ctx.strokeStyle='rgba(255,220,230,.8)'; ctx.stroke();
      ctx.restore(); return;
    }

    ctx.beginPath(); ctx.arc(0,0,b.r,0,Math.PI*2);
    let core='#ffffff';
    if (b.type==='redSmall' || b.type==='redBig' || b.type==='redBigDot') core='#ff4d4d';
    if (b.type==='blob') core='#ff8ad6';
    if (b.type==='blackBig') core='#111111';
    if (b.type==='cyanSwift') core='#6feaf2';
    if (b.type==='amberHeavy') core='#ffc864';
    if (b.type==='violetGhost') core='rgba(190,140,255,.75)';
    if (b.type==='greenSeeker') core='#79ffb8';
    ctx.fillStyle=core; ctx.fill();

    if (b.type==='redBigDot'){
      ctx.beginPath(); ctx.arc(0,0, Math.max(2.5, b.r*0.35), 0, Math.PI*2);
      ctx.fillStyle='#0c0c0c'; ctx.fill();
    }

    if (b.type==='original'){
      ctx.lineWidth=2; ctx.strokeStyle='rgba(143,220,255,.7)';
      ctx.beginPath(); ctx.arc(0,0,b.r+5,0,Math.PI*2); ctx.stroke();
    } else if (b.type==='spawner'){
      ctx.lineWidth=2; ctx.strokeStyle= 'rgba(255,220,130,.9)';
      ctx.beginPath(); ctx.arc(0,0,b.r+5,0,Math.PI*2); ctx.stroke();
    } else if (b.type==='amberHeavy'){
      ctx.lineWidth=2; ctx.strokeStyle= 'rgba(255,220,130,.85)';
      ctx.beginPath(); ctx.arc(0,0,b.r+4,0,Math.PI*2); ctx.stroke();
    }
    ctx.restore();
  }

  function steerSeeker(b){
    let target=null, best=1e9;
    for (const r of balls){
      if (r._dead) continue;
      if (r.type==='redSmall' || r.type==='redBig' || r.type==='redBigDot'){
        const d = (r.x-b.x)*(r.x-b.x) + (r.y-b.y)*(r.y-b.y);
        if (d<best){ best=d; target=r; }
      }
    }
    if (target){
      const dx=target.x-b.x, dy=target.y-b.y, len=Math.max(1,Math.hypot(dx,dy));
      b.vx += (dx/len)*0.12; b.vy += (dy/len)*0.12;
      const sp = Math.hypot(b.vx,b.vy); if (sp>5.5){ const f=5.5/sp; b.vx*=f; b.vy*=f; }
    }
  }

  function periodicBehaviors(){
    for (const b of balls){
      if (b._dead) continue;
      if (b.type==='amberHeavy'){
        if ((b.life % 120) === 0 && aliveCount() < MAX_BALLS){
          const ang=Math.random()*Math.PI*2, sp=1+Math.random()*1.2;
          balls.push(makeBall({ x:b.x+Math.cos(ang)*(b.r+6), y:b.y+Math.sin(ang)*(b.r+6),
                                r:6.5, vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp, type:'small' }));
          __SFX.squish(0.5);
        }
      }
      if (b.type==='crimsonNova'){
        if (b.life > 120){
          b._dead = true;
          const shardN = 6 + Math.floor(Math.random()*5);
          for (let k=0;k<shardN;k++){
            const ang = (Math.PI*2)*k/shardN + Math.random()*0.2;
            const sp = 3.8 + Math.random()*1.6;
            const sh = makeBall({ x:b.x, y:b.y, r:6, vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp, type:'shard' });
            balls.push(sh);
          }
          __SFX.novaBoom();
        }
      }
    }
  }

  function step(){
    const W=window.innerWidth, H=window.innerHeight;
    const rects=getRects();

    if (!GAME_PAUSED){
      for (const b of balls){
        if (b._dead) continue;
        b.life++;
        b.x+=b.vx; b.y+=b.vy;
        if (b.type==='original') accelerateOriginal(b);
        if (b.type==='cyanSwift'){ b.vx*=1.003; b.vy*=1.003; }
        if (b.type==='violetGhost'){ b.vx*=1.001; b.vy*=1.001; }
        if (b.type==='greenSeeker') steerSeeker(b);
        if (b.type && b.type.startsWith('red') && Math.random()<0.02){
          b.vx += (Math.random()-.5)*0.5; b.vy += (Math.random()-.5)*0.5;
        }
        antiOrbit(b);
        bounceWall(b,W,H);
        for(const R of rects) collideWithRect(b,R);
        if (b.squashTimer>0) b.squashTimer--;
        if (b.jellyTimer>0)  b.jellyTimer--;
        if (b.balloonTimer>0) b.balloonTimer--;
      }

      periodicBehaviors();

      const grid=buildGrid();
      const pairs=nearbyPairs(grid);
      for(const [i,j] of pairs){ handleBallVsBall(i,j); }

      for(let k=balls.length-1;k>=0;k--) if (balls[k]._dead) balls.splice(k,1);
    }

    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const b of balls) drawBall(b);

    updateBallCount();
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);

  function hitBallAt(x,y,b){ const dx=b.x-x, dy=b.y-y; return Math.hypot(dx,dy)<=b.r+5; }

  document.addEventListener('click',(e)=>{
    if (e.target.closest('input, textarea, [contenteditable="true"]')) return;
    const x=e.clientX, y=e.clientY;
    let handled=false;

    if (!GAME_PAUSED){
      for (const b of balls){
        if (b._dead) continue;
        if (hitBallAt(x,y,b)){
          addScore(1); handled=true;
          const dx=b.x-x, dy=b.y-y, L=Math.max(1,Math.hypot(dx,dy));
          let px=(dx/L)*4.8, py=(dy/L)*4.8;
          const cap=(b.type==='original' && b.hasFast)?9:4;
          const sp=Math.hypot(px,py), f=Math.min(cap,sp)/(sp||1);
          b.vx = px*f; b.vy = py*f;

          if (b.type==='original'){
            if (b.sizeTier<15){ b.sizeTier++; b.r = tierToRadius(b.sizeTier); }
            b._clicks=(b._clicks||0)+1;
            if (b._clicks>=15){ b.hasFast=true; const s=Math.hypot(b.vx,b.vy); if (s<7){ const F=7/(s||1); b.vx*=F; b.vy*=F; } }
          }
          if ((b.type==='spawner' || b.type==='original') && aliveCount() < MAX_BALLS){
            const ang=Math.random()*Math.PI*2, spd=1.6+Math.random()*1.6;
            balls.push(makeBall({ x:b.x+Math.cos(ang)*(b.r+6), y:b.y+Math.sin(ang)*(b.r+6), r:Math.max(5,Math.round(b.r*0.6)), vx:Math.cos(ang)*spd, vy:Math.sin(ang)*spd, type:'small' }));
            __SFX.squish(0.45);
            updateBallCount();
          }
          break;
        }
      }
      if (!handled) { addScore(-1); __SFX.tap(0.4); }
    }
  });

  function spawnWhites(cx,cy,n){
    let created=0;
    while (aliveCount() < MAX_BALLS && created < n){
      const ang=Math.random()*Math.PI*2, sp=1.2+Math.random()*1.6;
      balls.push(makeBall({ x:cx+Math.cos(ang)*8, y:cy+Math.sin(ang)*8, r:6.5, vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp, type:'small' }));
      created++;
    }
    __SFX.squish(0.6);
    updateBallCount();
  }
  window.spawnWhitesAt = spawnWhites;

})();
</script>
