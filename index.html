/* ===== Patched Game Engine ===== */
(function(){
  const scoreEl = document.getElementById('score');
  const ballCountEl = document.getElementById('ballCount');
  const MAX_BALLS = 19;
  const RED_MAX = 6;
  const FACTORY_INTERVAL = 200;

  const canvas = document.getElementById('ballLayer');
  const ctx = canvas.getContext('2d');

  function resize(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.style.width = window.innerWidth+'px';
    canvas.style.height = window.innerHeight+'px';
    canvas.width = Math.round(window.innerWidth*dpr);
    canvas.height= Math.round(window.innerHeight*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  resize(); window.addEventListener('resize', resize);

  // Ball types
  const SMALL = 'small';
  const SPAWNER = 'spawner';
  const FACTORY = 'factory';
  const RED = 'red';

  function makeBall(o={}) {
    const {x=window.innerWidth/2, y=window.innerHeight/2, vx=1, vy=1, type=SMALL} = o;
    const r = type===SMALL?6 : type===SPAWNER?12 : type===FACTORY?20 : 8;
    return {x,y,vx,vy,r,type,orbit:null,chain:null,cooldown:0,_dead:false};
  }

  const balls = [ makeBall({type:SMALL}) ];
  const chains = [];

  function updateBallCount(){ ballCountEl.textContent = balls.filter(b=>!b._dead).length; }

  // ==== Collisions ====
  function handleCollision(a,b){
    if(a._dead||b._dead) return;
    const dx=b.x-a.x, dy=b.y-a.y;
    const dist=Math.hypot(dx,dy);
    if(dist>a.r+b.r) return;

    // Small + Small → Spawner
    if(a.type===SMALL && b.type===SMALL){
      a._dead=b._dead=true;
      balls.push(makeBall({x:(a.x+b.x)/2,y:(a.y+b.y)/2,vx:(a.vx+b.vx)/2,vy:(a.vy+b.vy)/2,type:SPAWNER}));
      return;
    }

    // Spawner + Spawner → Factory
    if(a.type===SPAWNER && b.type===SPAWNER){
      a._dead=b._dead=true;
      balls.push(makeBall({x:(a.x+b.x)/2,y:(a.y+b.y)/2,vx:(a.vx+b.vx)/2,vy:(a.vy+b.vy)/2,type:FACTORY}));
      return;
    }

    // Orbiting smalls around bigs
    if(a.type===SMALL && (b.type===SPAWNER||b.type===FACTORY)) a.orbit=b;
    if(b.type===SMALL && (a.type===SPAWNER||a.type===FACTORY)) b.orbit=a;

    // Orbiters collide → chain link
    if(a.orbit && b.orbit && a.orbit===b.orbit){
      if(!a.chain && !b.chain){
        const chain=[a,b];
        a.chain=b.chain=chain;
        chains.push(chain);
      } else if(a.chain && !b.chain){ a.chain.push(b); b.chain=a.chain; }
      else if(!a.chain && b.chain){ b.chain.push(a); a.chain=b.chain; }
    }
  }

  // ==== Update ====
  function update(){
    for(const b of balls){
      if(b._dead) continue;
      b.x+=b.vx; b.y+=b.vy;

      // Orbit behavior
      if(b.orbit && !b._dead){
        const cx=b.orbit.x, cy=b.orbit.y;
        const ang=Math.atan2(b.y-cy,b.x-cx)+0.05;
        const dist=b.orbit.r+20;
        b.x=cx+Math.cos(ang)*dist;
        b.y=cy+Math.sin(ang)*dist;
      }

      // Factory spawn small balls
      if(b.type===FACTORY){
        b.cooldown++;
        if(b.cooldown>FACTORY_INTERVAL && balls.length<MAX_BALLS){
          b.cooldown=0;
          balls.push(makeBall({x:b.x+Math.random()*20-10,y:b.y+Math.random()*20-10,type:SMALL}));
        }
      }

      // Wall bounce
      if(b.x-b.r<0||b.x+b.r>window.innerWidth) b.vx*=-1;
      if(b.y-b.r<0||b.y+b.r>window.innerHeight) b.vy*=-1;
    }

    // Collisions
    for(let i=0;i<balls.length;i++){
      for(let j=i+1;j<balls.length;j++){
        handleCollision(balls[i],balls[j]);
      }
    }

    // Remove dead
    for(let i=balls.length-1;i>=0;i--) if(balls[i]._dead) balls.splice(i,1);
  }

  // ==== Click to Launch + Chain Folding ====
  document.addEventListener('click',e=>{
    const x=e.clientX,y=e.clientY;
    let chainHit=false;
    for(const ch of chains){
      if(ch.length>2){
        const first=ch[0], last=ch[ch.length-1];
        if(Math.hypot(first.x-x,first.y-y)<first.r+5 ||
           Math.hypot(last.x-x,last.y-y)<last.r+5){
          const cx=ch.reduce((s,b)=>s+b.x,0)/ch.length;
          const cy=ch.reduce((s,b)=>s+b.y,0)/ch.length;
          const radius=ch.length*5;
          ch.forEach((b,i)=>{
            const ang=(i/ch.length)*Math.PI*2;
            b.x=cx+Math.cos(ang)*radius;
            b.y=cy+Math.sin(ang)*radius;
            b.vx=b.vy=0;
          });
          chainHit=true;
        }
      }
    }
    if(chainHit) return;

    // Otherwise launch balls
    for(const b of balls){
      if(Math.hypot(b.x-x,b.y-y)<b.r+5){
        const dx=b.x-x, dy=b.y-y, L=Math.hypot(dx,dy)||1;
        b.vx=(dx/L)*4.5; b.vy=(dy/L)*4.5;
      }
    }
  });

  // ==== Draw ====
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const ch of chains){
      ctx.beginPath();
      ctx.moveTo(ch[0].x,ch[0].y);
      for(const b of ch) ctx.lineTo(b.x,b.y);
      ctx.strokeStyle='rgba(255,255,255,0.5)';
      ctx.stroke();
    }
    for(const b of balls){
      ctx.beginPath();
      ctx.fillStyle=b.type===SMALL?'white':b.type===SPAWNER?'orange':b.type===FACTORY?'red':'#ff4d4d';
      ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
      ctx.fill();
    }
    updateBallCount();
  }

  // ==== Loop ====
  function loop(){
    if(!window.GAME_PAUSED) update();
    draw();
    requestAnimationFrame(loop);
  }
  loop();
})();
